<!DOCTYPE html>
<html>
<head>
  <title>Resume Query UI</title>
  <style>
    body { margin: 30px; font-family: Arial; max-width: 900px; }
    input, button { padding: 8px; width: 100%; margin: 6px 0; }
    .result { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .result a { margin-right: 10px; text-decoration: none; color: blue; }
    .result a:hover { text-decoration: underline; }
  </style>
</head>

<body>

<h2>Upload Resume</h2>
<input id="name" placeholder="Name">
<input id="rtype" placeholder="Resume Type">
<input id="role" placeholder="Occupation">
<input type="file" id="file">
<button onclick="upload()">Upload</button>
<pre id="uploadResult"></pre>

<hr>

<h2>Search Resumes</h2>
<input id="qname" placeholder="Name">
<input id="qrtype" placeholder="Resume Type">
<input id="qrole" placeholder="Occupation">
<button onclick="search()">Search</button>

<div id="results"></div>

<script>
const BACKEND = "http://localhost:8001";

// =============================
// UPLOAD API FUNCTION
// =============================
async function upload() {
  const fd = new FormData();
  fd.append("name", document.getElementById("name").value)
  fd.append("resumetype", document.getElementById("rtype").value)
  fd.append("occupation", document.getElementById("role").value)
  fd.append("file", document.getElementById("file").files[0])

  const r = await fetch(`${BACKEND}/ingest`, {
    method: "POST",
    body: fd
  });

  document.getElementById("uploadResult").innerText =
    JSON.stringify(await r.json(), null, 2);
}

// =============================
// SEARCH API FUNCTION (FIXED)
// =============================
async function search() {
  const name = document.getElementById("qname").value.trim();
  const resumetype = document.getElementById("qrtype").value.trim();
  const occupation = document.getElementById("qrole").value.trim();

  // BUILD FORM URLENCODED BODY (THIS FIXES YOUR ISSUE)
  const body = new URLSearchParams();
  if (name) body.append("name", name);
  if (resumetype) body.append("resumetype", resumetype);
  if (occupation) body.append("occupation", occupation);

  const r = await fetch(`${BACKEND}/search`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await r.json();
  const div = document.getElementById("results");
  div.innerHTML = "";

  if (!data || data.length === 0) {
    div.innerHTML = "<p>No resumes found.</p>";
    return;
  }

  data.forEach(x => {
    div.innerHTML += `
      <div class="result">
        <b>${x.name} - ${x.occupation}</b><br>
        ${x.filename}<br><br>

        <a href="${BACKEND}/document/${x.chroma_id}" target="_blank">Open Document</a>
        &nbsp; | &nbsp;
        <a href="${BACKEND}/download/${x.chroma_id}" download="${x.filename}">
          Download
        </a>
      </div>
    `;
  });
}

</script>
</body>
</html>
